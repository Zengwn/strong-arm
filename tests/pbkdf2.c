#include <string.h>
#include <minunit.h>
#include <pbkdf2.h>


/* Test known data */
START_TEST (test_vectors)
{
	uint8_t key[65];
	const uint8_t salt[] = {0xED,0x4C,0xCE,0xB3,0xE1,0xED,0x7A,0x77};
	const uint8_t password[] = "This passphrase is a secret.";
	const uint8_t key1[] = {0x03,0x60,0x76,0xA1,0x9E,0x98,0x0C,0x3C,0xBA,0xAB,0xA1,0x1F,0x1A,0x60,0x7C,0x86,0xE4,0x4C,0x37,0x4D,0x74,0xD1,0x8A,0x63,0x30,0x46,0x21,0xAB,0xB4,0x57,0xB2,0x36};
	const uint8_t key2[] = {0xB6,0x3C,0xC4,0xA2,0x56,0xC9,0xBC,0x27,0x75,0x1A,0x7A,0x41,0x4B,0x7D,0x1C,0x4F,0xEA,0xC5,0x6F,0xFE,0xBB,0xC7,0x2B,0x68,0x9A,0x57,0x04,0xCC,0x7F,0xE1,0x6A,0x25};
	const uint8_t key3[] = {0xD1,0x89,0x4C,0xC8,0x4C,0xB8,0x0F,0xD7,0x9E,0x22,0x92,0xD2,0xEC,0x4A,0x5A,0x31,0xFD,0x16,0x14,0xC5,0x4A,0xEB,0xE5,0x58,0x65,0x98,0x76,0xF9,0x94,0x55,0xBE,0x2E,0xF7,0x02,0x2F,0x1C,0x95,0xF6,0xC7,0x05,0x7F,0x47,0xE2,0x86,0x98,0xBA,0x18,0x6F,0x30,0x95,0x58,0x53,0x07,0xFF,0x28,0x87,0x2E,0x67,0xBB,0xCB};
	
	memset (key, 0x55, 65);
	
	PBKDF2 (key, password, sizeof(password)-1, salt, sizeof(salt), 2000, 32);
	mu_assert (memcmp (key, key1, 32) == 0, "PBKDF2 should generate a valid key for the test strings.");
	mu_assert (key[32] == 0x55, "PBKDF2 should not write more than the requested keylength to the destination.");
	
	PBKDF2 (key, password, sizeof(password)-1, salt, sizeof(salt), 1, 32);
	mu_assert (memcmp (key, key2, 32) == 0, "PBKDF2 should generate a valid key for the test strings.");
	mu_assert (key[32] == 0x55, "PBKDF2 should not write more than the requested keylength to the destination.");
	
	PBKDF2 (key, password, sizeof(password)-1, salt, sizeof(salt), 1000, 60);
	mu_assert (memcmp (key, key3, 60) == 0, "PBKDF2 should generate a valid key for the test strings.");
	mu_assert (key[64] == 0x55, "PBKDF2 should not write more than the requested keylength to the destination.");
}
END_TEST


char *test_pbkdf2 (void)
{
	mu_run_test (test_vectors);
	
	return 0;
}
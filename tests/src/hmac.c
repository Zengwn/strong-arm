#include <string.h>
#include <minunit.h>
#include <strong-arm/hmac.h>
#include <strong-arm/random.h>


/* Test known data */
START_TEST (test_vectors)
{
	uint8_t hash[33] = {0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55};
	const uint8_t key1[] = "key";
	uint8_t msg1[] = "The quick brown fox jumps over the lazy dog";
	const uint8_t hash1[] = {0xf7,0xbc,0x83,0xf4,0x30,0x53,0x84,0x24,0xb1,0x32,0x98,0xe6,0xaa,0x6f,0xb1,0x43,0xef,0x4d,0x59,0xa1,0x49,0x46,0x17,0x59,0x97,0x47,0x9d,0xbc,0x2d,0x1a,0x3c,0xd8};
	const uint8_t key2[] = "How much wood would a woodchuck chuck if a woodchuck could chuck wood?";	// Long key
	const uint8_t msg2[] = "The quick brown fox jumps over the lazy dog";
	const uint8_t hash2[] = {0xeb,0x2a,0x0b,0x02,0xf3,0x4e,0xcd,0xa3,0x11,0x9c,0x3e,0x83,0x14,0x30,0x3b,0xa1,0xaa,0x20,0x11,0x0c,0xaf,0xe0,0x5f,0x52,0x6f,0xee,0xd3,0xef,0x72,0x42,0xe4,0x27};
	const uint8_t key3[] = "Tesla";
	const uint8_t msg3[] = "Giddy Fortune's furious fickle wheel, That goddess blind, That stands upon the rolling restless stone.";	// Long message
	const uint8_t hash3[] = {0xf7,0x9f,0xaa,0x21,0x93,0x9f,0x2f,0xd9,0xb5,0x3d,0x1d,0xb8,0x47,0xc9,0xfd,0xb0,0xd8,0xef,0xd0,0xf7,0x2c,0xf6,0x89,0x02,0x2d,0x53,0x82,0xdd,0xcc,0x8d,0x89,0x32};
	
	HMAC (hash, key1, sizeof(key1)-1, msg1, sizeof(msg1)-1);
	mu_assert (memcmp (hash, hash1, 32) == 0, "HMAC should correctly hash the test strings.");
	
	memmove (hash, key1, sizeof(key1));
	HMAC (hash, hash, sizeof(key1)-1, msg1, sizeof(msg1)-1);
	mu_assert (memcmp (hash, hash1, 32) == 0, "HMAC should correctly hash the test strings, even if the destination and key point to the same memory.");
	
	HMAC (msg1, key1, sizeof(key1)-1, msg1, sizeof(msg1)-1);
	mu_assert (memcmp (msg1, hash1, 32) == 0, "HMAC should correctly hash the test strings, even if the destination and message point to the same memory.");
	
	HMAC (hash, key2, sizeof(key2)-1, msg2, sizeof(msg2)-1);
	mu_assert (memcmp (hash, hash2, 32) == 0, "HMAC should correctly hash the test strings, even when the key is longer than 64 bytes.");
	
	HMAC (hash, key3, sizeof(key3)-1, msg3, sizeof(msg3)-1);
	mu_assert (memcmp (hash, hash3, 32) == 0, "HMAC should correctly hash the test strings, even when the msg is longer than 64 bytes.");
	
	mu_assert (hash[32] == 0x55, "HMAC should not write more than 32 bytes to the destination.");
}
END_TEST


/* HMAC calls out to HMAC_partial internally, so we don't need to recheck any of the above vectors. */
START_TEST (test_hmac_partial)
{
	HMAC_STATE state;
	uint8_t hash[33] = {0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55};
	const uint8_t key1[] = {0x7f,0xa6,0x5b,0x9f,0x6e,0xc5,0x69,0x1b,0xec,0x69,0x6c,0xe0,0x12,0xce,0x98,0x9f,0x72,0x75,0x03,0x1c,0x97,0x60,0x42,0x8b,0xcc,0x40,0x1b,0xc1,0xba,0x90,0x57,0xa5,0xe7,0x48,0xe8,0xda,0x39,0x9a,0x58,0x2c,0xfd,0x63,0x38,0x50,0x55,0xf2,0xbf,0x8b,0xe2,0x9c,0x57,0xd1,0xd3,0xd3,0x65,0xa1,0x05,0x4c,0xd0,0xe1,0x10,0x94,0x62,0xb7};
	const uint8_t hash1[] = {0xe0,0xd2,0x88,0x37,0x6e,0xa8,0xf5,0x01,0xf4,0x7b,0xb0,0x79,0x66,0xea,0x77,0x20,0x21,0xfa,0x34,0xa0,0xe8,0x84,0x66,0x4c,0xa1,0x70,0xc8,0xb6,0x4a,0xdc,0x75,0x87};
	uint8_t buf[256];

	/* Check for state dependant bugs */
	random_bytes ((uint8_t *)&state, sizeof (state));
	random_bytes (buf, sizeof (buf));

	HMAC_partial (NULL, &state, key1, sizeof (key1), NULL, 0, true, false);

	for (int i = 0; i < 10000;)
	{
		int len = (i % (sizeof (buf) - 1)) + 1;

		if (len > (10000 - i))
			len = 10000 - i;

		for (int j = 0; j < len; ++j)
			buf[j] = i++;

		HMAC_partial (NULL, &state, NULL, i, buf, len, false, false);
	}

	HMAC_partial (hash, &state, NULL, 0, NULL, 0, false, true);
	mu_assert (memcmp (hash, hash1, 32) == 0, "HMAC_partial should correctly hash the test strings.");
	
	mu_assert (hash[32] == 0x55, "HMAC_partial should not write more than 32 bytes to the destination.");
}
END_TEST


char *test_hmac (void)
{
	mu_run_test (test_vectors);
	mu_run_test (test_hmac_partial);
	
	return 0;
}
